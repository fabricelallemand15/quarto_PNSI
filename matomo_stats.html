<script>
document.addEventListener("DOMContentLoaded", function () {
    var matomoBaseUrl = "https://sitelf.fr/matomo/";
    var siteId = "3";
    var pageViewsElement = document.getElementById("page-views");

    if (!pageViewsElement) return;

    var isLocal = /^(localhost|127\.0\.0\.1)$/.test(window.location.hostname);
    var productionHost = "sitelf.fr";
    var hostname = isLocal ? productionHost : window.location.hostname;
    var protocol = isLocal ? "https:" : window.location.protocol;
    var pathname = window.location.pathname;
    var targetUrl = protocol + "//" + hostname + pathname;

    var normalizedPath = pathname.replace(/\/index\.html$/, "").replace(/\/$/, "");
    var pathParts = normalizedPath.split("/").filter(Boolean);
    var isPostPage = pathParts.length >= 2 && pathParts[0] === "posts";

    function displayHits(hits) {
        pageViewsElement.innerHTML = '<i class="fa-solid fa-eye"></i> ' + hits + " vues";
    }

    function displayUnavailable() {
        pageViewsElement.innerHTML = '<i class="fa-solid fa-eye"></i> indisponible';
    }

    function cleanupCallback(callbackName) {
        delete window[callbackName];
        var script = document.getElementById(callbackName);
        if (script) script.remove();
    }

    function requestJsonp(url, onSuccess, onError) {
        var callbackName = "matomoCb_" + Math.floor(Math.random() * 1e9);
        window[callbackName] = function (data) {
            cleanupCallback(callbackName);
            onSuccess(data);
        };

        var script = document.createElement("script");
        script.id = callbackName;
        script.src = url + "&jsoncallback=" + callbackName;
        script.onerror = function () {
            cleanupCallback(callbackName);
            onError();
        };
        document.body.appendChild(script);
    }

    function findHitsByLabel(nodes, label) {
        if (!Array.isArray(nodes)) return null;
        for (var i = 0; i < nodes.length; i += 1) {
            var node = nodes[i];
            if (node && node.label === label && typeof node.nb_hits === "number") return node.nb_hits;
            var nested = findHitsByLabel(node && node.subtable, label);
            if (nested !== null) return nested;
        }
        return null;
    }

    function fallbackExactUrl() {
        var fallbackUrl = matomoBaseUrl + "index.php?module=API&method=Actions.getPageUrl"
            + "&idSite=" + siteId
            + "&pageUrl=" + encodeURIComponent(targetUrl)
            + "&format=JSON"
            + "&period=range&date=2018-01-01,today";

        requestJsonp(fallbackUrl, function (data) {
            var hits = 0;
            if (Array.isArray(data) && data.length && typeof data[0].nb_hits === "number") {
                hits = data[0].nb_hits;
            } else if (data && typeof data.nb_hits === "number") {
                hits = data.nb_hits;
            }
            displayHits(hits);
        }, function () {
            displayUnavailable();
        });
    }

    if (!isPostPage) {
        fallbackExactUrl();
        return;
    }

    var slug = pathParts[1];
    var segmentPath = "/posts/" + slug;
    var groupedUrl = matomoBaseUrl + "index.php?module=API&method=Actions.getPageUrls"
        + "&idSite=" + siteId
        + "&format=JSON"
        + "&expanded=1"
        + "&period=range&date=2018-01-01,today"
        + "&segment=" + encodeURIComponent("pageUrl=@" + segmentPath);

    requestJsonp(groupedUrl, function (data) {
        var hits = findHitsByLabel(data, slug);
        if (typeof hits === "number") {
            displayHits(hits);
        } else {
            fallbackExactUrl();
        }
    }, function () {
        fallbackExactUrl();
    });
});
</script>
